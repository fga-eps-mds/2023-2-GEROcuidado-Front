name: Export de mÃ©tricas

on:
  push:
    branches:
      - develop
    tags:
      - "v*"

jobs:
  release:
    runs-on: "ubuntu-latest"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Create .env file
        run: |
          touch ./scripts/.env
          echo "TOKEN=${{ secrets.API_TOKEN_GITHUB }}" >> ./scripts/.env
          echo "RELEASE_MAJOR=${{ contains(github.event.pull_request.labels.*.name, 'MAJOR RELEASE') }}" >> ./scripts/.env
          echo "RELEASE_MINOR=${{ contains(github.event.pull_request.labels.*.name, 'MINOR RELEASE') }}" >> ./scripts/.env

      - name: Generate release and send metrics to DOC repository
        run: |
          cd scripts && yarn install && node release.js
          git config --global user.email "${{ secrets.USER_EMAIL }}"
          git config --global user.name "${{ secrets.USER_NAME }}"
          git clone --single-branch --branch main "https://x-access-token:${{ secrets.API_TOKEN_GITHUB }}"@github.com/fga-eps-mds/${{ secrets.API_TOKEN_DOC}} ${{ secrets.API_TOKEN_DOC}}
          mkdir -p ${{ secrets.API_TOKEN_DOC }}/analytics-raw-data
          cp -R analytics-raw-data/*.json ${{ secrets.API_TOKEN_DOC }}/analytics-raw-data
          cd ${{ secrets.API_TOKEN_DOC }}
          git add .
          git commit -m "Add metrics from repository ${{ github.event.repository.name }} ${{ github.ref_name }}"
          git push
